<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{layout/default_layout}">

<div layout:fragment="content">
    <article class="post-detail">
        <h1 class="post-title" th:text="${post.title}"></h1>
        <div class="post-meta">
            <span>작성자: <span th:text="${post.author}"></span></span>
            <span>작성일: <span th:text="${#temporals.format(post.createdAt, 'yyyy-MM-dd HH:mm')}"></span></span>
        </div>
        <hr />
        <div class="post-content" th:utext="${@markdownRenderer.render(post.content)}"></div>
        <hr />
        <div class="post-actions">
            <a href="/" class="btn">목록으로</a>
            <form th:action="@{/posts/delete/{id}(id=${post.id})}" method="post" style="display:inline;">
                <button type="submit" class="btn btn-danger">삭제</button>
            </form>
        </div>

        <div class="comments-section">
            <h3>Comments</h3>

            <form id="comment-form">
                <input type="hidden" id="postId" th:value="${post.id}">
                <textarea id="comment-content" placeholder="Add a comment..." required></textarea>
                <button type="submit">Submit</button>
            </form>

            <ul id="comments-list">
                <li th:each="comment : ${post.comments}" th:id="'comment-' + ${comment.id}">
                    <p th:text="${comment.content}"></p>
                    <small>by <strong th:text="${comment.author}"></strong> at <span
                            th:text="${#temporals.format(comment.createdAt, 'yyyy-MM-dd HH:mm')}"></span></small>
                    <button class="delete-comment-btn" th:data-comment-id="${comment.id}">Delete</button>
                </li>
            </ul>
        </div>

        <script>
            document.addEventListener('DOMContentLoaded', function () {
                const commentForm = document.getElementById('comment-form');
                const commentsList = document.getElementById('comments-list');

                // Handle Comment Submission
                commentForm.addEventListener('submit', function (e) {
                    e.preventDefault();
                    const postId = document.getElementById('postId').value;
                    const content = document.getElementById('comment-content').value;

                    fetch('/api/comments', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ postId: postId, content: content })
                    })
                        .then(response => {
                            if (!response.ok) throw new Error('Failed to save comment');
                            // Simply reload for now to see the new comment
                            location.reload();
                        })
                        .catch(error => console.error('Error:', error));
                });

                // Handle Comment Deletion
                commentsList.addEventListener('click', function (e) {
                    if (e.target && e.target.classList.contains('delete-comment-btn')) {
                        const commentId = e.target.getAttribute('data-comment-id');
                        if (confirm('Are you sure you want to delete this comment?')) {
                            fetch(`/api/comments/${commentId}`, { method: 'DELETE' })
                                .then(response => {
                                    if (response.ok) {
                                        document.getElementById(`comment-${commentId}`).remove();
                                    } else {
                                        alert('Failed to delete comment.');
                                    }
                                })
                                .catch(error => console.error('Error:', error));
                        }
                    }
                });
            });
        </script>
    </article>
</div>

</html>